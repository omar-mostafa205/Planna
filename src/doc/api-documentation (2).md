"# API Reference Documentation\n\n## Overview\n\n**Technology Stack:**\n*   **Web Framework:** Next.js\n*   **Database ORM:** Prisma\n*   **Authentication:** Clerk\n*   **Payments:** Stripe\n*   **AI/LLM:** OpenAI (via OpenRouter)\n*   **Language:** TypeScript\n*   **Validation:** Zod (client-side)\n\n**Base URL:** The base URL is configured via the `NEXT_PUBLIC_URL` environment variable.\n\n**Summary:**\nThis API provides backend services for \"Planna,\" an AI-powered diet and nutrition planning application. It handles user management through Clerk webhooks, processes subscription payments via Stripe, and leverages an AI model to generate personalized meal plans based on user-provided data, including InBody scan images. The API exposes endpoints for plan generation, retrieval, and payment processing, and uses webhooks to synchronize user and subscription data with its local database.\n\n---\n\n## Authentication\n\n### Authentication Method\n\n**Type Detected:** Clerk (JWT-based session management)\n\n**Implementation Location:** `omar-mostafa205-Planna-aea2b49/src/middleware.ts`\n\n**How Authentication Works:**\nThe application uses Clerk for user authentication. The `clerkMiddleware` function is applied to most routes, automatically managing user sessions and protecting routes. In the API endpoints, the `auth()` helper function from `@clerk/nextjs/server` is used to retrieve the authenticated user's ID (`userId`). This `userId` is then used to query the database for user-specific data.\n\n**Code Reference:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/middleware.ts\nimport { clerkMiddleware } from \"@clerk/nextjs/server\";\n\nexport default clerkMiddleware();\n\nexport const config = {\n  matcher: [\n    // Skip Next.js internals and all static files, unless found in search params\n    '/((?!_next|[^?]*\\\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',\n    // Always run for API routes\n    '/(api|trpc)(.*)',\n  ],\n};\n```\n\n### Authentication Flow\n\nThe authentication flow is managed by Clerk's components and hosted pages for sign-up and sign-in. Once a user is authenticated, the `clerkMiddleware` maintains their session.\n\n**Protected Route Access:**\nAPI routes that require authentication call the `auth()` function to verify the session and get the user's ID. If no valid session exists, the call will fail, preventing unauthorized access.\n\n**Token Usage:**\nThe `auth()` function validates the session token provided in the request headers to extract the `userId`.\n\n```typescript\n// Example from omar-mostafa205-Planna-aea2b49/src/app/api/get-plan/route.ts\nimport { auth } from \"@clerk/nextjs/server\";\n\nexport async function GET() {\n  try {\n    const { userId } = await auth();\n    if (!userId) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n    // ... logic for authenticated user\n```\n\n### Authorization\n\nNo role-based or permission-based authorization system was found in the provided codebase. Access control is based solely on user authentication (i.e., having a valid `userId`).\n\n---\n\n## API Endpoints\n\n### Meal Plan Management\n\n#### `POST /api/generate-plan`\n\n**Source:** `omar-mostafa205-Planna-aea2b49/src/app/api/generate-plan/route.ts:29`\n\n**Description:** Generates a personalized meal plan using an AI model. It accepts user biometrics, goals, and an optional InBody scan image for analysis. The generated plan is then saved to the user's profile in the database.\n\n**Authentication Required:** Yes\n\n**Route Handler:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/api/generate-plan/route.ts\nexport async function POST(req: Request) {\n  try {\n    const { userId } = await auth();\n    if (!userId) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n    \n    // ... logic to parse FormData, process image, and call OpenAI\n    \n    const mealPlan = await openai.chat.completions.create({\n      model: \"mistralai/mistral-small-3.1-24b-instruct:free\",\n      messages: [{ role: \"user\", content: planPrompt }],\n      response_format: { type: \"json_object\" }\n    });\n    \n    // ... logic to parse AI response and save to database\n\n    await prisma.profile.update({\n      where: { userId },\n      data: { mealPlan: mealPlanJson },\n    });\n\n    return NextResponse.json(mealPlanJson);\n  } catch (error: any) {\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n```\n\n**Request Body Schema:**\nThe request body must be `multipart/form-data`. The expected fields are defined by the client-side Zod schema.\n\n*   `fullName`: `string`\n*   `age`: `string`\n*   `height`: `string`\n*   `gender`: `string`\n*   `activityLevel`: `string`\n*   `goals`: `string`\n*   `medicalConditions`: `string` (optional)\n*   `images`: `File[]` (one or more image files)\n\n**Response Schema:**\nThe endpoint returns the JSON object generated by the AI, which conforms to the structure requested in the prompt. See the `MealPlanData` type in the [Type Definitions](#mealplandata) section for a similar structure.\n\n**Error Responses:**\n\n| Status Code | Condition | Response |\n|-------------|-----------|----------|\n| 401 | User is not authenticated. | `{\"error\": \"Unauthorized\"}` |\n| 400 | No form data found in the request. | `{\"error\": \"No form data found\"}` |\n| 500 | An internal server error occurred during image processing, AI generation, or database update. | `{\"error\": \"[error message]\"}` |\n\n**Database Operations:**\n*   **Writes to:** `Profile` table (updates the `mealPlan` field for the user).\n\n**Side Effects:**\n*   Calls the OpenRouter/OpenAI API to perform image analysis (if an image is provided) and to generate the meal plan.\n\n---\n\n#### `GET /api/get-plan`\n\n**Source:** `omar-mostafa205-Planna-aea2b49/src/app/api/get-plan/route.ts:6`\n\n**Description:** Retrieves the existing meal plan for the currently authenticated user from the database.\n\n**Authentication Required:** Yes\n\n**Route Handler:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/api/get-plan/route.ts\nexport async function GET() {\n  try {\n    const { userId } = await auth();\n    if (!userId) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const profile = await prisma.profile.findUnique({\n      where: { userId },\n      select: { mealPlan: true }\n    });\n\n    if (!profile || !profile.mealPlan) {\n      return NextResponse.json({ error: \"No meal plan found\" }, { status: 404 });\n    }\n    \n    return NextResponse.json(profile.mealPlan);\n\n  } catch (error: any) {\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n```\n\n**Response Schema:**\nReturns the JSON object stored in the `mealPlan` field of the user's profile.\n\n**Success Response Example:**\n```json\n{\n  \"calories\": 2500,\n  \"protein\": 180,\n  \"carbs\": 250,\n  \"fat\": 80,\n  \"currentWeight\": 85,\n  \"bodyFat\": 15,\n  \"muscleMass\": 40,\n  \"goal\": \"Build lean muscle while maintaining body fat percentage.\",\n  \"meals\": {\n    \"breakfast\": {\n      \"title\": \"...\",\n      \"calories\": 500,\n      \"protein\": 30,\n      \"carbs\": 60,\n      \"fat\": 15,\n      \"ingredients\": [\"...\"],\n      \"instructions\": [\"...\"]\n    }\n    // ... other meals (lunch, dinner, snack)\n  }\n}\n```\n\n**Error Responses:**\n\n| Status Code | Condition | Response |\n|-------------|-----------|----------|\n| 401 | User is not authenticated. | `{\"error\": \"Unauthorized\"}` |\n| 404 | The user has no meal plan. | `{\"error\": \"No meal plan found\"}` |\n| 500 | An internal server error occurred. | `{\"error\": \"[error message]\"}` |\n\n**Database Operations:**\n*   **Reads from:** `Profile` table.\n\n---\n\n### Subscription Management\n\n#### `POST /api/check-out`\n\n**Source:** `omar-mostafa205-Planna-aea2b49/src/app/api/check-out/route.ts:6`\n\n**Description:** Creates a Stripe Checkout session for a user to purchase a subscription plan.\n\n**Authentication Required:** Not explicitly enforced via `auth()` in the handler, but it receives a `userId` in the body. The route is likely protected by the global `clerkMiddleware`.\n\n**Route Handler:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/api/check-out/route.ts\nexport async function POST(request: Request) {\n  try {\n    const { planType, userId, email } = await request.json();\n\n    const priceId = planType.toLowerCase() === 'premium'\n      ? process.env.NEXT_PUBLIC_STRIPE_PREMIUM\n      : process.env.NEXT_PUBLIC_STRIPE_BASIC;\n\n    const session = await stripe.checkout.sessions.create({\n      payment_method_types: ['card'],\n      line_items: [{\n        price: priceId,\n        quantity: 1,\n      }],\n      mode: 'subscription',\n      success_url: `${process.env.NEXT_PUBLIC_URL}/success?session_id={CHECKOUT_SESSION_ID}`,\n      cancel_url: `${process.env.NEXT_PUBLIC_URL}/cancel`,\n      customer_email: email,\n      metadata: { userId },\n    });\n\n    return NextResponse.json({ url: session.url });\n  } catch (error: any) {\n    return new NextResponse(error.message, { status: 500 });\n  }\n}\n```\n\n**Request Body Schema:**\n```typescript\n// Inferred from code\ninterface CheckoutRequestBody {\n  planType: 'premium' | 'basic';\n  userId: string;\n  email: string;\n}\n```\n\n**Response Schema:**\n```typescript\n// Type definition from omar-mostafa205-Planna-aea2b49/src/app/(main)/subscription/page.tsx\ntype SubscriptionResponse = {\n  url: string;\n};\n```\n\n**Error Responses:**\n\n| Status Code | Condition | Response |\n|-------------|-----------|----------|\n| 400 | The request body is missing or malformed. | (Implicit framework error) |\n| 500 | Failed to create a Stripe Checkout session. | `[error message string]` |\n\n**Side Effects:**\n*   Creates a `checkout.session` object via the Stripe API.\n\n---\n\n## Data Models\n\n⚠️ No `schema.prisma` file was found in the codebase. The following model definition is inferred from Prisma Client usage across multiple API routes.\n\n### Profile\n\n**Source:** Inferred from `prisma.profile` calls in `src/app/api/` routes.\n\n**Database Table/Collection:** `Profile`\n\n**Inferred Schema Definition:**\nBased on usage, the `Profile` model likely contains the following fields. The exact types (`String`, `Boolean`, `Json`, etc.) and attributes (`@id`, `@unique`, `@default`) are an approximation.\n\n```prisma\n// This is an INFERRED schema. The actual schema file was not provided.\nmodel Profile {\n  id                   String    @id @default(cuid())\n  userId               String    @unique // Clerk User ID\n  email                String\n  mealPlan             Json?\n  subscriptionActive   Boolean   @default(false)\n  subscriptionTier     String?\n  stripeSubscriptionId String?   @unique\n  createdAt            DateTime  @default(now())\n  updatedAt            DateTime  @updatedAt\n}\n```\n\n**Field Details:**\n\n| Field | Inferred Type | Required | Description |\n|-------|---------------|----------|-------------|\n| `userId` | `String` | Yes | The user's ID from Clerk. Used as the primary link. |\n| `email` | `String` | Yes | The user's email address. |\n| `mealPlan` | `Json` | No | A JSON object containing the user's generated meal plan. |\n| `subscriptionActive` | `Boolean` | Yes | Flag indicating if the user has an active Stripe subscription. |\n| `subscriptionTier` | `String` | No | The name of the active subscription plan (e.g., 'basic', 'premium'). |\n| `stripeSubscriptionId`| `String` | No | The ID of the subscription from Stripe. |\n\n**Relationships:**\nNo relationships to other models were found in the codebase.\n\n---\n\n## Type Definitions\n\n### MealPlanData\n\n**Source:** `omar-mostafa205-Planna-aea2b49/src/app/(main)/dashboard/page.tsx`\n\n**Definition:**\nThis interface defines the structure for a complete meal plan, including nutritional summaries and daily meals.\n\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/(main)/dashboard/page.tsx\ninterface MealPlanData {\n  calories: number;\n  protein: number;\n  carbs: number;\n  fat: number;\n  currentWeight: number;\n  bodyFat: number;\n  muscleMass: number;\n  goal: string;\n  meals: {\n    breakfast: Meal;\n    lunch: Meal;\n    dinner: Meal;\n    snack: Meal;\n  };\n}\n```\n\n**Used By:**\n*   `src/app/(main)/dashboard/page.tsx` (Frontend component)\n\n**Related Types:**\n*   [Meal](#meal)\n\n---\n\n### Meal\n\n**Source:** `omar-mostafa205-Planna-aea2b49/src/app/(main)/dashboard/page.tsx`\n\n**Definition:**\nThis interface defines the structure for an individual meal within the `MealPlanData`.\n\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/(main)/dashboard/page.tsx\ninterface Meal {\n  title: string;\n  calories: number;\n  protein: number;\n  carbs: number;\n  fat: number;\n  ingredients: string[];\n  instructions: string[];\n}\n```\n\n---\n\n## Business Logic & Services\n\n### Stripe Webhook Handlers\n\n**Location:** `omar-mostafa205-Planna-aea2b49/src/app/api/webhook/stripe/route.ts`\n\n**Purpose:** These functions are defined locally within the Stripe webhook route to process different types of subscription events and update the database accordingly.\n\n#### `handleCheckoutSessionCompleted()`\n\n**Signature:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/api/webhook/stripe/route.ts\nconst handleCheckoutSessionCompleted = async (\n  session: Stripe.Checkout.Session\n) => { ... }\n```\n\n**Implementation:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/api/webhook/stripe/route.ts\nconst handleCheckoutSessionCompleted = async (\n  session: Stripe.Checkout.Session\n) => {\n  const userId = session.metadata?.clerkUserId;\n  // ...\n  const subscriptionId = session.subscription as string;\n  // ...\n  await prisma.profile.update({\n    where: { userId },\n    data: {\n      stripeSubscriptionId: subscriptionId,\n      subscriptionActive: true,\n      subscriptionTier: session.metadata?.planType || null,\n    },\n  });\n};\n```\n\n**Parameters:**\n\n| Parameter | Type | Required | Description |\n|-----------|------|----------|-------------|\n| `session` | `Stripe.Checkout.Session` | Yes | The Stripe session object from the `checkout.session.completed` event. |\n\n**Returns:** `Promise<void>`\n\n**Database Queries:**\n*   Updates the `Profile` record for the `userId` found in session metadata, setting subscription details.\n\n---\n\n#### `handleInvoicePaymentFailed()`\n\n**Signature:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/api/webhook/stripe/route.ts\nconst handleInvoicePaymentFailed = async (invoice: Stripe.Invoice) => { ... }\n```\n\n**Implementation:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/api/webhook/stripe/route.ts\nconst handleInvoicePaymentFailed = async (invoice: Stripe.Invoice) => {\n  const subscriptionId = invoice.subscription as string;\n  // ...\n  const profile = await prisma.profile.findUnique({\n    where: { stripeSubscriptionId: subscriptionId },\n    select: { userId: true },\n  });\n  // ...\n  await prisma.profile.update({\n    where: { userId },\n    data: {\n      subscriptionActive: false,\n    },\n  });\n};\n```\n\n**Database Queries:**\n*   Finds a `Profile` by `stripeSubscriptionId`.\n*   Updates the found `Profile` to set `subscriptionActive` to `false`.\n\n---\n\n#### `handleSubscriptionDeleted()`\n\n**Signature:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/api/webhook/stripe/route.ts\nconst handleSubscriptionDeleted = async (subscription: Stripe.Subscription) => { ... }\n```\n\n**Implementation:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/api/webhook/stripe/route.ts\nconst handleSubscriptionDeleted = async (subscription: Stripe.Subscription) => {\n  const subscriptionId = subscription.id;\n  // ...\n  const profile = await prisma.profile.findUnique({\n    where: { stripeSubscriptionId: subscriptionId },\n    select: { userId: true },\n  });\n  // ...\n  await prisma.profile.update({\n    where: { userId },\n    data: {\n      subscriptionActive: false,\n      stripeSubscriptionId: null,\n    },\n  });\n};\n```\n\n**Database Queries:**\n*   Finds a `Profile` by `stripeSubscriptionId`.\n*   Updates the found `Profile` to set `subscriptionActive` to `false` and nullify `stripeSubscriptionId`.\n\n---\n\n## Middleware\n\n### Clerk Authentication Middleware\n\n**Source:** `omar-mostafa205-Planna-aea2b49/src/middleware.ts`\n\n**Purpose:** This middleware, provided by Clerk, is responsible for managing user sessions across the application. It inspects incoming requests, validates session tokens, and makes authentication data available to server components and API routes.\n\n**Implementation:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/middleware.ts\nimport { clerkMiddleware } from \"@clerk/nextjs/server\";\n\nexport default clerkMiddleware();\n\nexport const config = {\n  matcher: [\n    '/((?!_next|[^?]*\\\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',\n    '/(api|trpc)(.*)',\n  ],\n};\n```\n\n**Applied To:**\nThe middleware is applied to all routes that are not static files or Next.js internal paths, including all API routes under `/api/`.\n\n---\n\n## Webhooks\n\nThis section details incoming webhooks from third-party services.\n\n### Clerk User Webhook\n\n**Endpoint:** `POST /api/webhook/clerk`\n\n**Source:** `omar-mostafa205-Planna-aea2b49/src/app/api/webhook/clerk/route.ts:6`\n\n**Triggered When:** A user is created or updated in Clerk.\n\n**Webhook Code:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/api/webhook/clerk/route.ts\nexport async function POST(req: Request) {\n  try {\n    const { data } = await req.json();\n    const eventType = data.event; // This line is inferred, not explicit in AST\n\n    const email = data?.email_addresses?.[0]?.email_address;\n    const clerkUserId = data?.id;\n    // ... validation\n    \n    const profile = await prisma.$transaction(async (tx) => {\n      return tx.profile.upsert({\n        where: { userId: clerkUserId },\n        create: {\n          userId: clerkUserId,\n          email,\n          subscriptionActive: false,\n          subscriptionTier: null,\n          stripeSubscriptionId: null,\n        },\n        update: { email },\n      });\n    });\n\n    return NextResponse.json({ success: true, profile });\n  } catch (error: any) {\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n```\n\n**Payload:** The payload is a Clerk user event object. The handler extracts `id` and `email_addresses`.\n\n**Database Operations:**\n*   Performs an `upsert` on the `Profile` table to create a new user profile or update an existing one's email address. The operation is wrapped in a transaction.\n\n---\n\n### Stripe Subscription Webhook\n\n**Endpoint:** `POST /api/webhook/stripe`\n\n**Source:** `omar-mostafa205-Planna-aea2b49/src/app/api/webhook/stripe/route.ts:11`\n\n**Triggered When:** Stripe subscription events occur, such as a successful checkout, a failed payment, or a canceled subscription.\n\n**Webhook Code:**\n```typescript\n// omar-mostafa205-Planna-aea2b49/src/app/api/webhook/stripe/route.ts\nexport async function POST(req: NextRequest) {\n  // ... signature verification logic\n  try {\n    event = stripe.webhooks.constructEvent(body, signature!, webhookSecret);\n  } catch (err: any) {\n    // ... error handling\n  }\n\n  switch (event.type) {\n    case 'checkout.session.completed':\n      const session = event.data.object as Stripe.Checkout.Session;\n      await handleCheckoutSessionCompleted(session);\n      break;\n    case 'invoice.payment_failed':\n      const invoice = event.data.object as Stripe.Invoice;\n      await handleInvoicePaymentFailed(invoice);\n      break;\n    case 'customer.subscription.deleted':\n      const subscription = event.data.object as Stripe.Subscription;\n      await handleSubscriptionDeleted(subscription);\n      break;\n    default:\n      console.warn(`Unhandled event type: ${event.type}`);\n  }\n\n  return NextResponse.json({ received: true });\n}\n```\n\n**Payload:** A Stripe `Event` object. The handler processes `checkout.session.completed`, `invoice.payment_failed`, and `customer.subscription.deleted` events.\n\n**Database Operations:**\n*   Updates the `Profile` table to reflect changes in subscription status. See [Stripe Webhook Handlers](#stripe-webhook-handlers) for details.\n\n---\n\n## Configuration & Environment\n\n**Environment Variables Used:**\n\n| Variable | Used In | Purpose |\n|----------|---------|---------|\n| `OPENROUTER_API_KEY` | `src/app/api/generate-plan/route.ts` | API key for OpenRouter service to access AI models. |\n| `STRIPE_SECRET_KEY` | `src/app/api/webhook/stripe/route.ts`, `src/lib/stripe.ts` | Secret key for authenticating with the Stripe API. |\n| `STRIPE_WEBHOOK_KEY` | `src/app/api/webhook/stripe/route.ts` | Secret for verifying incoming Stripe webhooks. |\n| `NEXT_PUBLIC_STRIPE_PREMIUM` | `src/app/api/check-out/route.ts` | Stripe Price ID for the \"Premium\" subscription plan. |\n| `NEXT_PUBLIC_STRIPE_BASIC` | `src/app/api/check-out/route.ts` | Stripe Price ID for the \"Basic\" subscription plan. |\n| `NEXT_PUBLIC_URL` | `src/app/api/check-out/route.ts` | Base URL of the deployed application, used for Stripe success/cancel URLs. |\n\n---\n\n## Limitations of This Documentation\n\n- Generated from static code analysis of AST.\n- Runtime behavior may differ from static analysis.\n- The Prisma schema (`schema.prisma`) was not provided; the `Profile` data model is inferred from client usage and may be incomplete.\n- Dynamic routes or programmatically generated endpoints may not be captured.\n- Environment-specific configurations may not be visible.\n- Third-party service integrations (like the exact prompts for OpenAI) may not be fully documented.\n- **This documentation only includes what exists in the provided code.**"